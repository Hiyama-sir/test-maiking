<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞è„ÉÜ„Çπ„Éà„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #333;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #fafafa;
            border-radius: 10px;
            border-left: 5px solid #333;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: "üìö";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .row-number {
            background: #e0e0e0;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .word {
            font-weight: 600;
            color: #333;
        }

        .meaning {
            color: #666;
        }

        .test-generator {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #333;
        }

        .btn {
            background: #333;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: #555;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .test-result {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #333;
            display: none;
        }

        .test-result h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .test-result h3::before {
            content: "‚úÖ";
            margin-right: 10px;
        }

        .test-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .test-item .question {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .test-item .answer {
            color: #666;
            font-style: italic;
        }

        /* 2Âàó„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆ„ÉÜ„Çπ„ÉàÁî®„Çπ„Çø„Ç§„É´ */
        .test-format-2column {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #333;
        }

        .test-header h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .test-header .info {
            color: #666;
            font-size: 1.1em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .test-column {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }

        .test-column h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .test-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .test-table th {
            background: #333;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #333;
        }

        .test-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ccc;
            background: white;
        }

        .test-table .number {
            width: 60px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .test-table .word {
            width: 200px;
            font-weight: 600;
            color: #333;
            text-align: left;
            padding-left: 10px;
        }

        .test-table .answer {
            width: 300px;
            background: #f9f9f9;
            border: 2px dashed #999;
            min-height: 80px;
            padding: 15px;
        }

        /* ÂõûÁ≠îÁî®Á¥ô„ÅÆ„Çπ„Çø„Ç§„É´ */
        .answer-sheet-format {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .answer-sheet-format .test-table .answer {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            color: #2e7d32;
            font-weight: 600;
        }

        .answer-sheet-format .test-table .answer::before {
            content: "Á≠î„Åà: ";
            font-weight: bold;
        }

        .print-controls {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .print-controls button {
            margin: 0 10px;
        }

        /* Âç∞Âà∑Áî®„Çπ„Çø„Ç§„É´ */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .test-format-2column,
            .test-format-2column * {
                visibility: visible;
            }
            
            .test-format-2column {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                box-shadow: none;
                border: none;
            }
            
            .print-controls {
                display: none;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
        }

        /* ÂõûÁ≠îÁî®Á¥ôÂç∞Âà∑Áî®„Çπ„Çø„Ç§„É´ */
        @media print {
            .answer-sheet-format,
            .answer-sheet-format * {
                visibility: visible;
            }
            
            .answer-sheet-format {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                box-shadow: none;
                border: none;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-top: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .instructions h3::before {
            content: "üí°";
            margin-right: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #333;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            color: #333;
            flex: 1;
        }

        .checkbox-item .word-preview {
            font-weight: 600;
            color: #333;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .selection-summary {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #333;
        }

        .selection-summary h4 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .selection-summary h4::before {
            content: "üìã";
            margin-right: 10px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-btn:hover {
            background: #333;
            color: white;
            border-color: #333;
        }

        .quick-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .range-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .range-selector h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .range-selector h4::before {
            content: "üî¢";
            margin-right: 10px;
        }

        .range-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .range-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .range-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .range-input-group input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
        }

        .range-input-group input:focus {
            outline: none;
            border-color: #333;
        }

        .range-separator {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0 10px;
        }

        .range-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .range-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .range-btn:hover {
            background: #555;
        }

        .range-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .random-range-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .random-range-selector h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .random-range-selector h4::before {
            content: "üé≤";
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Â∞è„ÉÜ„Çπ„Éà„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</h1>
        </div>

        
        <div class="content">
            <div class="instructions">
                <h3>Á∞°Âçò„Å™‰Ωø„ÅÑÊñπ</h3>
                <ul>
                    <li>‰∏ã„ÅÆË°®„Åã„Çâ„ÉÜ„Çπ„Éà„Å´Âê´„ÇÅ„Åü„ÅÑÂçòË™û„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                    <li>„ÄåÈÅ∏Êäû„Åó„ÅüÂçòË™û„Åß„ÉÜ„Çπ„Éà‰ΩúÊàê„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÉÜ„Çπ„Éà„ÇíÁîüÊàê</li>
                    <li>„ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„Éú„Çø„É≥„ÅßÁ∞°Âçò„Å´ÈÅ∏Êäû„Åß„Åç„Åæ„Åô</li>
                    <li>ÁØÑÂõ≤ÊåáÂÆö„ÅßÈÄ£Á∂ö„Åó„ÅüÂçòË™û„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô</li>
                    <li>ÁØÑÂõ≤„Åã„Çâ„É©„É≥„ÉÄ„É†„ÅßÊåáÂÆöÂÄãÊï∞„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô</li>
                </ul>
            </div>

            <div class="section">
                <h2>ÂçòË™û‰∏ÄË¶ß„Å®ÈÅ∏Êäû</h2>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="selectAll()">ÂÖ®ÈÅ∏Êäû</button>
                    <button class="quick-btn" onclick="deselectAll()">ÂÖ®Ëß£Èô§</button>
                    <button class="quick-btn" onclick="selectRandom(5)">„É©„É≥„ÉÄ„É†5ÂÄã</button>
                    <button class="quick-btn" onclick="selectRandom(10)">„É©„É≥„ÉÄ„É†10ÂÄã</button>
                </div>

                <div class="range-selector">
                    <h4>ÁØÑÂõ≤ÊåáÂÆö„ÅßÈÅ∏Êäû</h4>
                    <div class="range-inputs">
                        <div class="range-input-group">
                            <label for="startRow">ÈñãÂßãË°å</label>
                            <input type="number" id="startRow" placeholder="2" min="1">
                        </div>
                        <div class="range-separator">„Äú</div>
                        <div class="range-input-group">
                            <label for="endRow">ÁµÇ‰∫ÜË°å</label>
                            <input type="number" id="endRow" placeholder="10" min="1">
                        </div>
                    </div>
                    <div class="range-buttons">
                        <button class="range-btn" onclick="selectRange()">ÁØÑÂõ≤„ÇíÈÅ∏Êäû</button>
                        <button class="range-btn" onclick="clearRangeInputs()">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>

                <div class="random-range-selector">
                    <h4>ÁØÑÂõ≤„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû</h4>
                    <div class="range-inputs">
                        <div class="range-input-group">
                            <label for="randomStartRow">ÈñãÂßãË°å</label>
                            <input type="number" id="randomStartRow" placeholder="1" min="1">
                        </div>
                        <div class="range-separator">„Äú</div>
                        <div class="range-input-group">
                            <label for="randomEndRow">ÁµÇ‰∫ÜË°å</label>
                            <input type="number" id="randomEndRow" placeholder="50" min="1">
                        </div>
                        <div class="range-separator">„Åã„Çâ</div>
                        <div class="range-input-group">
                            <label for="randomCount">ÂÄãÊï∞</label>
                            <input type="number" id="randomCount" placeholder="10" min="1">
                        </div>
                        <div class="range-separator">ÂÄã</div>
                    </div>
                    <div class="range-buttons">
                        <button class="range-btn" onclick="selectRandomFromRange()">„É©„É≥„ÉÄ„É†ÈÅ∏Êäû</button>
                        <button class="range-btn" onclick="clearRandomInputs()">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                
                <div class="checkbox-container" id="checkboxContainer">
                    {% for item in data %}
                    <div class="checkbox-item">
                        <input type="checkbox" id="row{{ item.row_number }}" value="{{ item.row_number }}" onchange="updateSelection()">
                        <label for="row{{ item.row_number }}">
                            <strong>{{ item.row_number }}Ë°åÁõÆ</strong>
                            <span class="word-preview">{{ item.word }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div class="selection-summary" id="selectionSummary">
                    <h4>ÈÅ∏ÊäûÁä∂Ê≥Å</h4>
                    <p id="selectionText"></p>
                </div>
            </div>

            <div class="test-generator">
                <h2>„ÉÜ„Çπ„Éà‰ΩúÊàê</h2>
                <div class="form-group">
                    <label>ÈÅ∏Êäû„Åï„Çå„ÅüÂçòË™ûÊï∞: <span id="selectedCount">0</span>ÂÄã</label>
                </div>
                
                <button class="btn" onclick="generateTest()" id="generateBtn" disabled>ÈÅ∏Êäû„Åó„ÅüÂçòË™û„Åß„ÉÜ„Çπ„Éà‰ΩúÊàê</button>
                <button class="btn btn-secondary" onclick="clearSelection()">ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢</button>
                <button class="btn btn-danger" onclick="printTest()" id="printBtn" disabled>„ÉÜ„Çπ„Éà„ÇíÂç∞Âà∑</button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>„ÉÜ„Çπ„Éà„ÇíÁîüÊàê‰∏≠...</p>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="test-result" id="testResult">
                    <h3>ÁîüÊàê„Åï„Çå„Åü„ÉÜ„Çπ„Éà</h3>
                    <div id="testContent"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="show2ColumnTest()">2Âàó„É¨„Ç§„Ç¢„Ç¶„Éà„ÅßË°®Á§∫</button>
                        <button class="btn btn-secondary" onclick="showAnswerSheet()">ÂõûÁ≠îÁî®Á¥ô„ÇíË°®Á§∫</button>
                        <button class="btn btn-danger" onclick="printBothSheets()">ÂïèÈ°åÁî®Á¥ô„Å®ÂõûÁ≠îÁî®Á¥ô„Çí‰∏°ÊñπÂç∞Âà∑</button>
                    </div>
                </div>

                <!-- 2Âàó„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆ„ÉÜ„Çπ„ÉàÂΩ¢Âºè -->
                <div class="test-format-2column" id="testFormat2Column" style="display: none;">
                    <div class="test-header">
                        <h2>Ëã±ÂçòË™û„ÉÜ„Çπ„Éà</h2>
                        <div class="info">ÈÅ∏Êäû„Åï„Çå„ÅüÂçòË™ûÊï∞: <span id="testWordCount">0</span>ÂÄã</div>
                    </div>
                    
                    <div class="test-grid" id="testGrid">
                        <!-- 2Âàó„ÅÆ„ÉÜ„Çπ„Éà„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                    
                    <div class="print-controls">
                        <button class="btn" onclick="printTest()">ÂïèÈ°åÁî®Á¥ô„ÇíÂç∞Âà∑</button>
                        <button class="btn btn-secondary" onclick="showSimpleTest()">„Ç∑„É≥„Éó„É´Ë°®Á§∫„Å´Êàª„Åô</button>
                    </div>
                </div>

                <!-- ÂõûÁ≠îÁî®Á¥ôÔºàËß£Á≠î‰ªò„ÅçÔºâ„ÅÆÂΩ¢Âºè -->
                <div class="answer-sheet-format" id="answerSheetFormat" style="display: none;">
                    <div class="test-header">
                        <h2>Ëã±ÂçòË™û„ÉÜ„Çπ„Éà - ÂõûÁ≠îÁî®Á¥ô</h2>
                        <div class="info">ÈÅ∏Êäû„Åï„Çå„ÅüÂçòË™ûÊï∞: <span id="answerWordCount">0</span>ÂÄã</div>
                    </div>
                    
                    <div class="test-grid" id="answerGrid">
                        <!-- ÂõûÁ≠îÁî®Á¥ô„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                    </div>
                    
                    <div class="print-controls">
                        <button class="btn" onclick="printAnswerSheet()">ÂõûÁ≠îÁî®Á¥ô„ÇíÂç∞Âà∑</button>
                        <button class="btn btn-secondary" onclick="showSimpleTest()">„Ç∑„É≥„Éó„É´Ë°®Á§∫„Å´Êàª„Åô</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedRows = [];

        function updateSelection() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            selectedRows = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const selectedCount = document.getElementById('selectedCount');
            const generateBtn = document.getElementById('generateBtn');
            const printBtn = document.getElementById('printBtn');
            const selectionSummary = document.getElementById('selectionSummary');
            const selectionText = document.getElementById('selectionText');
            
            selectedCount.textContent = selectedRows.length;
            generateBtn.disabled = selectedRows.length === 0;
            printBtn.disabled = selectedRows.length === 0;
            
            if (selectedRows.length > 0) {
                selectionSummary.style.display = 'block';
                selectionText.textContent = `ÈÅ∏Êäû„Åï„Çå„ÅüË°å: ${selectedRows.join(', ')}`;
            } else {
                selectionSummary.style.display = 'none';
            }
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelection();
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelection();
        }

        function selectRandom(count) {
            deselectAll();
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const shuffled = Array.from(checkboxes).sort(() => 0.5 - Math.random());
            
            for (let i = 0; i < Math.min(count, checkboxes.length); i++) {
                shuffled[i].checked = true;
            }
            updateSelection();
        }

        function clearSelection() {
            deselectAll();
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function generateTest() {
            if (selectedRows.length === 0) {
                showError('ÂçòË™û„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const loading = document.getElementById('loading');
            const testResult = document.getElementById('testResult');
            const errorMessage = document.getElementById('errorMessage');

            loading.style.display = 'block';
            testResult.style.display = 'none';
            errorMessage.style.display = 'none';

            fetch('/generate_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selected_rows: selectedRows
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    displayTest(data.test_data);
                } else {
                    showError(data.error || '„ÉÜ„Çπ„Éà„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            });
        }

        function displayTest(testData) {
            const testResult = document.getElementById('testResult');
            const testContent = document.getElementById('testContent');
            const testFormat2Column = document.getElementById('testFormat2Column');
            const testWordCount = document.getElementById('testWordCount');

            // ÂçòË™ûÊï∞„ÇíÊõ¥Êñ∞
            testWordCount.textContent = testData.length;

            // „Ç∑„É≥„Éó„É´Ë°®Á§∫
            let html = '';
            testData.forEach((item, index) => {
                html += `
                    <div class="test-item">
                        <div class="question">ÂïèÈ°å ${index + 1}: <strong>${item.word}</strong> „ÅÆÊÑèÂë≥„ÇíÁ≠î„Åà„Å™„Åï„ÅÑ</div>
                        <div class="answer">Á≠î„Åà: ${item.meaning}</div>
                    </div>
                `;
            });

            testContent.innerHTML = html;
            testResult.style.display = 'block';

            // 2Âàó„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆ„ÉÜ„Çπ„Éà„Å®ÂõûÁ≠îÁî®Á¥ô„ÇÇÁîüÊàê
            generate2ColumnTest(testData);
            generateAnswerSheet(testData);
        }

        function generate2ColumnTest(testData) {
            const testGrid = document.getElementById('testGrid');
            
            let html = '';
            
            if (testData.length <= 25) {
                // 25ÂÄã‰ª•‰∏ã„ÅØÂ∑¶Âàó„ÅÆ„Åø
                html += '<div class="test-column" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">';
                html += '<h3>„ÉÜ„Çπ„ÉàÂïèÈ°å</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠îÊ¨Ñ</th></tr></thead>';
                html += '<tbody>';
                testData.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer"></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            } else {
                // 25ÂÄã‰ª•‰∏ä„ÅØ2Âàó„Å´ÂàÜÂâ≤
                const midPoint = Math.ceil(testData.length / 2);
                const leftColumn = testData.slice(0, midPoint);
                const rightColumn = testData.slice(midPoint);
                
                            // Â∑¶Âàó
            html += '<div class="test-column">';
            html += '<h3>Â∑¶Âàó</h3>';
            html += '<table class="test-table">';
            html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠îÊ¨Ñ</th></tr></thead>';
            html += '<tbody>';
            leftColumn.forEach((item, index) => {
                html += `<tr>
                    <td class="number">${item.row_number}</td>
                    <td class="word">${item.word}</td>
                    <td class="answer"></td>
                </tr>`;
            });
            html += '</tbody></table>';
            html += '</div>';
            
            // Âè≥Âàó
            html += '<div class="test-column">';
            html += '<h3>Âè≥Âàó</h3>';
            html += '<table class="test-table">';
            html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠îÊ¨Ñ</th></tr></thead>';
            html += '<tbody>';
            rightColumn.forEach((item, index) => {
                html += `<tr>
                    <td class="number">${item.row_number}</td>
                    <td class="word">${item.word}</td>
                    <td class="answer"></td>
                </tr>`;
            });
            html += '</tbody></table>';
            html += '</div>';
            }
            
            testGrid.innerHTML = html;
        }

        function generateAnswerSheet(testData) {
            const answerGrid = document.getElementById('answerGrid');
            const answerWordCount = document.getElementById('answerWordCount');
            
            // ÂçòË™ûÊï∞„ÇíÊõ¥Êñ∞
            answerWordCount.textContent = testData.length;
            
            let html = '';
            
            if (testData.length <= 25) {
                // 25ÂÄã‰ª•‰∏ã„ÅØÂ∑¶Âàó„ÅÆ„Åø
                html += '<div class="test-column" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">';
                html += '<h3>ÂõûÁ≠îÁî®Á¥ôÔºàËß£Á≠î‰ªò„ÅçÔºâ</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠î</th></tr></thead>';
                html += '<tbody>';
                testData.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            } else {
                // 25ÂÄã‰ª•‰∏ä„ÅØ2Âàó„Å´ÂàÜÂâ≤
                const midPoint = Math.ceil(testData.length / 2);
                const leftColumn = testData.slice(0, midPoint);
                const rightColumn = testData.slice(midPoint);
                
                // Â∑¶Âàó
                html += '<div class="test-column">';
                html += '<h3>Â∑¶ÂàóÔºàËß£Á≠î‰ªò„ÅçÔºâ</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠î</th></tr></thead>';
                html += '<tbody>';
                leftColumn.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
                
                // Âè≥Âàó
                html += '<div class="test-column">';
                html += '<h3>Âè≥ÂàóÔºàËß£Á≠î‰ªò„ÅçÔºâ</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">Áï™Âè∑</th><th class="word">Ëã±ÂçòË™û</th><th class="answer">Ëß£Á≠î</th></tr></thead>';
                html += '<tbody>';
                rightColumn.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            }
            
            answerGrid.innerHTML = html;
        }

        function show2ColumnTest() {
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('testFormat2Column').style.display = 'block';
            document.getElementById('answerSheetFormat').style.display = 'none';
        }

        function showAnswerSheet() {
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('testFormat2Column').style.display = 'none';
            document.getElementById('answerSheetFormat').style.display = 'block';
        }

        function showSimpleTest() {
            document.getElementById('testResult').style.display = 'block';
            document.getElementById('testFormat2Column').style.display = 'none';
            document.getElementById('answerSheetFormat').style.display = 'none';
        }

        function printTest() {
            const testFormat2Column = document.getElementById('testFormat2Column');
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            
            if (testFormat2Column.style.display !== 'none') {
                // ÂõûÁ≠îÁî®Á¥ô„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶ÂïèÈ°åÁî®Á¥ô„ÅÆ„Åø„ÇíÂç∞Âà∑
                const originalAnswerDisplay = answerSheetFormat.style.display;
                answerSheetFormat.style.display = 'none';
                
                setTimeout(() => {
                    window.print();
                    // Âç∞Âà∑Âæå„ÅØÂÖÉ„ÅÆË°®Á§∫„Å´Êàª„Åô
                    answerSheetFormat.style.display = originalAnswerDisplay;
                }, 100);
            } else {
                alert('2Âàó„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆ„ÉÜ„Çπ„Éà„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâÂç∞Âà∑„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
        }

        function printAnswerSheet() {
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            const testFormat2Column = document.getElementById('testFormat2Column');
            
            if (answerSheetFormat.style.display !== 'none') {
                // ÂïèÈ°åÁî®Á¥ô„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶ÂõûÁ≠îÁî®Á¥ô„ÅÆ„Åø„ÇíÂç∞Âà∑
                const originalTestDisplay = testFormat2Column.style.display;
                testFormat2Column.style.display = 'none';
                
                setTimeout(() => {
                    window.print();
                    // Âç∞Âà∑Âæå„ÅØÂÖÉ„ÅÆË°®Á§∫„Å´Êàª„Åô
                    testFormat2Column.style.display = originalTestDisplay;
                }, 100);
            } else {
                alert('ÂõûÁ≠îÁî®Á¥ô„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâÂç∞Âà∑„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
        }

        function printBothSheets() {
            const testFormat2Column = document.getElementById('testFormat2Column');
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            
            // ‰∏°Êñπ„ÅÆÁî®Á¥ô„ÇíË°®Á§∫„Åó„Å¶Âç∞Âà∑
            const originalTestDisplay = testFormat2Column.style.display;
            const originalAnswerDisplay = answerSheetFormat.style.display;
            
            testFormat2Column.style.display = 'block';
            answerSheetFormat.style.display = 'block';
            
            setTimeout(() => {
                window.print();
                // Âç∞Âà∑Âæå„ÅØÂÖÉ„ÅÆË°®Á§∫„Å´Êàª„Åô
                testFormat2Column.style.display = originalTestDisplay;
                answerSheetFormat.style.display = originalAnswerDisplay;
            }, 100);
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function selectRange() {
            const startRow = parseInt(document.getElementById('startRow').value);
            const endRow = parseInt(document.getElementById('endRow').value);
            
            if (!startRow || !endRow) {
                alert('ÈñãÂßãË°å„Å®ÁµÇ‰∫ÜË°å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (startRow > endRow) {
                alert('ÈñãÂßãË°å„ÅØÁµÇ‰∫ÜË°å„Çà„ÇäÂ∞è„Åï„ÅÑÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            let selectedCount = 0;
            
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            deselectAll();
            
            for (let i = 0; i < checkboxes.length; i++) {
                const rowNumber = parseInt(checkboxes[i].value);
                if (rowNumber >= startRow && rowNumber <= endRow) {
                    checkboxes[i].checked = true;
                    selectedCount++;
                }
            }
            
            updateSelection();
            
            if (selectedCount > 0) {
                alert(`${startRow}Ë°åÁõÆ„Åã„Çâ${endRow}Ë°åÁõÆ„Åæ„Åß„ÅÆÂçòË™û„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇÈÅ∏Êäû„Åï„Çå„ÅüÂçòË™ûÊï∞: ${selectedCount}ÂÄã`);
            } else {
                alert('ÊåáÂÆö„Åï„Çå„ÅüÁØÑÂõ≤„Å´ÂçòË™û„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
        }

        function clearRangeInputs() {
            document.getElementById('startRow').value = '';
            document.getElementById('endRow').value = '';
        }

        function selectRandomFromRange() {
            const startRow = parseInt(document.getElementById('randomStartRow').value);
            const endRow = parseInt(document.getElementById('randomEndRow').value);
            const count = parseInt(document.getElementById('randomCount').value);
            
            if (!startRow || !endRow || !count) {
                alert('ÈñãÂßãË°å„ÄÅÁµÇ‰∫ÜË°å„ÄÅÂÄãÊï∞„Çí„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (startRow > endRow) {
                alert('ÈñãÂßãË°å„ÅØÁµÇ‰∫ÜË°å„Çà„ÇäÂ∞è„Åï„ÅÑÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const availableRows = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            
            // ÊåáÂÆöÁØÑÂõ≤ÂÜÖ„ÅÆË°åÁï™Âè∑„ÇíÂèñÂæó
            for (let i = 0; i < checkboxes.length; i++) {
                const rowNumber = parseInt(checkboxes[i].value);
                if (rowNumber >= startRow && rowNumber <= endRow) {
                    availableRows.push(checkboxes[i]);
                }
            }
            
            if (availableRows.length === 0) {
                alert('ÊåáÂÆö„Åï„Çå„ÅüÁØÑÂõ≤„Å´ÂçòË™û„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }
            
            if (count > availableRows.length) {
                alert(`ÊåáÂÆö„Åï„Çå„ÅüÁØÑÂõ≤„Å´„ÅØ${availableRows.length}ÂÄã„ÅÆÂçòË™û„Åó„Åã„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ${count}ÂÄã‰ª•‰∏ã„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                return;
            }
            
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            deselectAll();
            
            // „É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
            const shuffled = availableRows.sort(() => 0.5 - Math.random());
            for (let i = 0; i < count; i++) {
                shuffled[i].checked = true;
            }
            
            updateSelection();
            alert(`${startRow}Ë°åÁõÆ„Åã„Çâ${endRow}Ë°åÁõÆ„Åæ„Åß„ÅÆÁØÑÂõ≤„Åã„Çâ„ÄÅ„É©„É≥„ÉÄ„É†„Å´${count}ÂÄã„ÅÆÂçòË™û„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ`);
        }

        function clearRandomInputs() {
            document.getElementById('randomStartRow').value = '';
            document.getElementById('randomEndRow').value = '';
            document.getElementById('randomCount').value = '';
        }


        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            updateSelection();
        });
    </script>
</body>
</html>
