<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ãƒ†ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #333;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #fafafa;
            border-radius: 10px;
            border-left: 5px solid #333;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: "ğŸ“š";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .row-number {
            background: #e0e0e0;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .word {
            font-weight: 600;
            color: #333;
        }

        .meaning {
            color: #666;
        }

        .test-generator {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #333;
        }

        .btn {
            background: #333;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: #555;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .test-result {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #333;
            display: none;
        }

        .test-result h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .test-result h3::before {
            content: "âœ…";
            margin-right: 10px;
        }

        .test-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .test-item .question {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .test-item .answer {
            color: #666;
            font-style: italic;
        }

        /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .test-format-2column {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #333;
        }

        .test-header h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .test-header .info {
            color: #666;
            font-size: 1.1em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .test-column {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }

        .test-column h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .test-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .test-table th {
            background: #333;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #333;
        }

        .test-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ccc;
            background: white;
        }

        .test-table .number {
            width: 60px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .test-table .word {
            width: 200px;
            font-weight: 600;
            color: #333;
            text-align: left;
            padding-left: 10px;
        }

        .test-table .answer {
            width: 300px;
            background: #f9f9f9;
            border: 2px dashed #999;
            min-height: 80px;
            padding: 15px;
        }

        /* å›ç­”ç”¨ç´™ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .answer-sheet-format {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .answer-sheet-format .test-table .answer {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            color: #2e7d32;
            font-weight: 600;
        }

        .answer-sheet-format .test-table .answer::before {
            content: "ç­”ãˆ: ";
            font-weight: bold;
        }

        .print-controls {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .print-controls button {
            margin: 0 10px;
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .test-format-2column,
            .test-format-2column * {
                visibility: visible;
            }
            
            .test-format-2column {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                box-shadow: none;
                border: none;
            }
            
            .print-controls {
                display: none;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
        }

        /* å›ç­”ç”¨ç´™å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            .answer-sheet-format,
            .answer-sheet-format * {
                visibility: visible;
            }
            
            .answer-sheet-format {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                box-shadow: none;
                border: none;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-top: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .instructions h3::before {
            content: "ğŸ’¡";
            margin-right: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #333;
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            color: #333;
            flex: 1;
        }

        .checkbox-item .word-preview {
            font-weight: 600;
            color: #333;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .selection-summary {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #333;
        }

        .selection-summary h4 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .selection-summary h4::before {
            content: "ğŸ“‹";
            margin-right: 10px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-btn:hover {
            background: #333;
            color: white;
            border-color: #333;
        }

        .quick-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .range-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .range-selector h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .range-selector h4::before {
            content: "ğŸ”¢";
            margin-right: 10px;
        }

        .range-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .range-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .range-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .range-input-group input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
        }

        .range-input-group input:focus {
            outline: none;
            border-color: #333;
        }

        .range-separator {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0 10px;
        }

        .range-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .range-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .range-btn:hover {
            background: #555;
        }

        .range-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .random-range-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .random-range-selector h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .random-range-selector h4::before {
            content: "ğŸ²";
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å°ãƒ†ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        </div>

        
        <div class="content">
            <div class="instructions">
                <h3>ç°¡å˜ãªä½¿ã„æ–¹</h3>
                <ul>
                    <li>ä¸‹ã®è¡¨ã‹ã‚‰ãƒ†ã‚¹ãƒˆã«å«ã‚ãŸã„å˜èªã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</li>
                    <li>ã€Œé¸æŠã—ãŸå˜èªã§ãƒ†ã‚¹ãƒˆä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆ</li>
                    <li>ã‚¯ã‚¤ãƒƒã‚¯é¸æŠãƒœã‚¿ãƒ³ã§ç°¡å˜ã«é¸æŠã§ãã¾ã™</li>
                    <li>ç¯„å›²æŒ‡å®šã§é€£ç¶šã—ãŸå˜èªã‚’é¸æŠã§ãã¾ã™</li>
                    <li>ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§æŒ‡å®šå€‹æ•°ã‚’é¸æŠã§ãã¾ã™</li>
                </ul>
            </div>

            <div class="section">
                <h2>å˜èªä¸€è¦§ã¨é¸æŠ</h2>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="selectAll()">å…¨é¸æŠ</button>
                    <button class="quick-btn" onclick="deselectAll()">å…¨è§£é™¤</button>
                    <button class="quick-btn" onclick="selectRandom(5)">ãƒ©ãƒ³ãƒ€ãƒ 5å€‹</button>
                    <button class="quick-btn" onclick="selectRandom(10)">ãƒ©ãƒ³ãƒ€ãƒ 10å€‹</button>
                </div>

                <div class="range-selector">
                    <h4>ç¯„å›²æŒ‡å®šã§é¸æŠ</h4>
                    <div class="range-inputs">
                        <div class="range-input-group">
                            <label for="startRow">é–‹å§‹è¡Œ</label>
                            <input type="number" id="startRow" placeholder="2" min="1">
                        </div>
                        <div class="range-separator">ã€œ</div>
                        <div class="range-input-group">
                            <label for="endRow">çµ‚äº†è¡Œ</label>
                            <input type="number" id="endRow" placeholder="10" min="1">
                        </div>
                    </div>
                    <div class="range-buttons">
                        <button class="range-btn" onclick="selectRange()">ç¯„å›²ã‚’é¸æŠ</button>
                        <button class="range-btn" onclick="clearRangeInputs()">ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>

                <div class="random-range-selector">
                    <h4>ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ</h4>
                    <div class="range-inputs">
                        <div class="range-input-group">
                            <label for="randomStartRow">é–‹å§‹è¡Œ</label>
                            <input type="number" id="randomStartRow" placeholder="1" min="1">
                        </div>
                        <div class="range-separator">ã€œ</div>
                        <div class="range-input-group">
                            <label for="randomEndRow">çµ‚äº†è¡Œ</label>
                            <input type="number" id="randomEndRow" placeholder="50" min="1">
                        </div>
                        <div class="range-separator">ã‹ã‚‰</div>
                        <div class="range-input-group">
                            <label for="randomCount">å€‹æ•°</label>
                            <input type="number" id="randomCount" placeholder="10" min="1">
                        </div>
                        <div class="range-separator">å€‹</div>
                    </div>
                    <div class="range-buttons">
                        <button class="range-btn" onclick="selectRandomFromRange()">ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ</button>
                        <button class="range-btn" onclick="clearRandomInputs()">ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
                
                <div class="checkbox-container" id="checkboxContainer">
                    {% for item in data %}
                    <div class="checkbox-item">
                        <input type="checkbox" id="row{{ item.row_number }}" value="{{ item.row_number }}" onchange="updateSelection()">
                        <label for="row{{ item.row_number }}">
                            <strong>{{ item.row_number }}è¡Œç›®</strong>
                            <span class="word-preview">{{ item.word }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div class="selection-summary" id="selectionSummary">
                    <h4>é¸æŠçŠ¶æ³</h4>
                    <p id="selectionText"></p>
                </div>
            </div>

            <div class="test-generator">
                <h2>ãƒ†ã‚¹ãƒˆä½œæˆ</h2>
                <div class="form-group">
                    <label>é¸æŠã•ã‚ŒãŸå˜èªæ•°: <span id="selectedCount">0</span>å€‹</label>
                </div>
                
                <button class="btn" onclick="generateTest()" id="generateBtn" disabled>é¸æŠã—ãŸå˜èªã§ãƒ†ã‚¹ãƒˆä½œæˆ</button>
                <button class="btn btn-secondary" onclick="clearSelection()">é¸æŠã‚’ã‚¯ãƒªã‚¢</button>
                <button class="btn btn-danger" onclick="printTest()" id="printBtn" disabled>ãƒ†ã‚¹ãƒˆã‚’å°åˆ·</button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆä¸­...</p>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="test-result" id="testResult">
                    <h3>ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ</h3>
                    <div id="testContent"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="show2ColumnTest()">2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡¨ç¤º</button>
                        <button class="btn btn-secondary" onclick="showAnswerSheet()">å›ç­”ç”¨ç´™ã‚’è¡¨ç¤º</button>
                        <button class="btn btn-danger" onclick="printBothSheets()">å•é¡Œç”¨ç´™ã¨å›ç­”ç”¨ç´™ã‚’ä¸¡æ–¹å°åˆ·</button>
                    </div>
                </div>

                <!-- 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ†ã‚¹ãƒˆå½¢å¼ -->
                <div class="test-format-2column" id="testFormat2Column" style="display: none;">
                    <div class="test-header">
                        <h2>è‹±å˜èªãƒ†ã‚¹ãƒˆ</h2>
                        <div class="info">é¸æŠã•ã‚ŒãŸå˜èªæ•°: <span id="testWordCount">0</span>å€‹</div>
                    </div>
                    
                    <div class="test-grid" id="testGrid">
                        <!-- 2åˆ—ã®ãƒ†ã‚¹ãƒˆãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="print-controls">
                        <button class="btn" onclick="printTest()">å•é¡Œç”¨ç´™ã‚’å°åˆ·</button>
                        <button class="btn btn-secondary" onclick="showSimpleTest()">ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºã«æˆ»ã™</button>
                    </div>
                </div>

                <!-- å›ç­”ç”¨ç´™ï¼ˆè§£ç­”ä»˜ãï¼‰ã®å½¢å¼ -->
                <div class="answer-sheet-format" id="answerSheetFormat" style="display: none;">
                    <div class="test-header">
                        <h2>è‹±å˜èªãƒ†ã‚¹ãƒˆ - å›ç­”ç”¨ç´™</h2>
                        <div class="info">é¸æŠã•ã‚ŒãŸå˜èªæ•°: <span id="answerWordCount">0</span>å€‹</div>
                    </div>
                    
                    <div class="test-grid" id="answerGrid">
                        <!-- å›ç­”ç”¨ç´™ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="print-controls">
                        <button class="btn" onclick="printAnswerSheet()">å›ç­”ç”¨ç´™ã‚’å°åˆ·</button>
                        <button class="btn btn-secondary" onclick="showSimpleTest()">ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºã«æˆ»ã™</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedRows = [];

        function updateSelection() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            selectedRows = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const selectedCount = document.getElementById('selectedCount');
            const generateBtn = document.getElementById('generateBtn');
            const printBtn = document.getElementById('printBtn');
            const selectionSummary = document.getElementById('selectionSummary');
            const selectionText = document.getElementById('selectionText');
            
            selectedCount.textContent = selectedRows.length;
            generateBtn.disabled = selectedRows.length === 0;
            printBtn.disabled = selectedRows.length === 0;
            
            if (selectedRows.length > 0) {
                selectionSummary.style.display = 'block';
                selectionText.textContent = `é¸æŠã•ã‚ŒãŸè¡Œ: ${selectedRows.join(', ')}`;
            } else {
                selectionSummary.style.display = 'none';
            }
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelection();
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelection();
        }

        function selectRandom(count) {
            deselectAll();
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const shuffled = Array.from(checkboxes).sort(() => 0.5 - Math.random());
            
            for (let i = 0; i < Math.min(count, checkboxes.length); i++) {
                shuffled[i].checked = true;
            }
            updateSelection();
        }

        function clearSelection() {
            deselectAll();
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function generateTest() {
            if (selectedRows.length === 0) {
                showError('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const testResult = document.getElementById('testResult');
            const errorMessage = document.getElementById('errorMessage');

            loading.style.display = 'block';
            testResult.style.display = 'none';
            errorMessage.style.display = 'none';

            fetch('/generate_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selected_rows: selectedRows
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    displayTest(data.test_data);
                } else {
                    showError(data.error || 'ãƒ†ã‚¹ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            });
        }

        function displayTest(testData) {
            const testResult = document.getElementById('testResult');
            const testContent = document.getElementById('testContent');
            const testFormat2Column = document.getElementById('testFormat2Column');
            const testWordCount = document.getElementById('testWordCount');

            // å˜èªæ•°ã‚’æ›´æ–°
            testWordCount.textContent = testData.length;

            // ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º
            let html = '';
            testData.forEach((item, index) => {
                html += `
                    <div class="test-item">
                        <div class="question">å•é¡Œ ${index + 1}: <strong>${item.word}</strong> ã®æ„å‘³ã‚’ç­”ãˆãªã•ã„</div>
                        <div class="answer">ç­”ãˆ: ${item.meaning}</div>
                    </div>
                `;
            });

            testContent.innerHTML = html;
            testResult.style.display = 'block';

            // 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ†ã‚¹ãƒˆã¨å›ç­”ç”¨ç´™ã‚‚ç”Ÿæˆ
            generate2ColumnTest(testData);
            generateAnswerSheet(testData);
        }

        function generate2ColumnTest(testData) {
            const testGrid = document.getElementById('testGrid');
            
            let html = '';
            
            if (testData.length <= 25) {
                // 25å€‹ä»¥ä¸‹ã¯å·¦åˆ—ã®ã¿
                html += '<div class="test-column" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">';
                html += '<h3>ãƒ†ã‚¹ãƒˆå•é¡Œ</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”æ¬„</th></tr></thead>';
                html += '<tbody>';
                testData.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer"></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            } else {
                // 25å€‹ä»¥ä¸Šã¯2åˆ—ã«åˆ†å‰²
                const midPoint = Math.ceil(testData.length / 2);
                const leftColumn = testData.slice(0, midPoint);
                const rightColumn = testData.slice(midPoint);
                
                            // å·¦åˆ—
            html += '<div class="test-column">';
            html += '<h3>å·¦åˆ—</h3>';
            html += '<table class="test-table">';
            html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”æ¬„</th></tr></thead>';
            html += '<tbody>';
            leftColumn.forEach((item, index) => {
                html += `<tr>
                    <td class="number">${item.row_number}</td>
                    <td class="word">${item.word}</td>
                    <td class="answer"></td>
                </tr>`;
            });
            html += '</tbody></table>';
            html += '</div>';
            
            // å³åˆ—
            html += '<div class="test-column">';
            html += '<h3>å³åˆ—</h3>';
            html += '<table class="test-table">';
            html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”æ¬„</th></tr></thead>';
            html += '<tbody>';
            rightColumn.forEach((item, index) => {
                html += `<tr>
                    <td class="number">${item.row_number}</td>
                    <td class="word">${item.word}</td>
                    <td class="answer"></td>
                </tr>`;
            });
            html += '</tbody></table>';
            html += '</div>';
            }
            
            testGrid.innerHTML = html;
        }

        function generateAnswerSheet(testData) {
            const answerGrid = document.getElementById('answerGrid');
            const answerWordCount = document.getElementById('answerWordCount');
            
            // å˜èªæ•°ã‚’æ›´æ–°
            answerWordCount.textContent = testData.length;
            
            let html = '';
            
            if (testData.length <= 25) {
                // 25å€‹ä»¥ä¸‹ã¯å·¦åˆ—ã®ã¿
                html += '<div class="test-column" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">';
                html += '<h3>å›ç­”ç”¨ç´™ï¼ˆè§£ç­”ä»˜ãï¼‰</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”</th></tr></thead>';
                html += '<tbody>';
                testData.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            } else {
                // 25å€‹ä»¥ä¸Šã¯2åˆ—ã«åˆ†å‰²
                const midPoint = Math.ceil(testData.length / 2);
                const leftColumn = testData.slice(0, midPoint);
                const rightColumn = testData.slice(midPoint);
                
                // å·¦åˆ—
                html += '<div class="test-column">';
                html += '<h3>å·¦åˆ—ï¼ˆè§£ç­”ä»˜ãï¼‰</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”</th></tr></thead>';
                html += '<tbody>';
                leftColumn.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
                
                // å³åˆ—
                html += '<div class="test-column">';
                html += '<h3>å³åˆ—ï¼ˆè§£ç­”ä»˜ãï¼‰</h3>';
                html += '<table class="test-table">';
                html += '<thead><tr><th class="number">ç•ªå·</th><th class="word">è‹±å˜èª</th><th class="answer">è§£ç­”</th></tr></thead>';
                html += '<tbody>';
                rightColumn.forEach((item, index) => {
                    html += `<tr>
                        <td class="number">${item.row_number}</td>
                        <td class="word">${item.word}</td>
                        <td class="answer">${item.meaning}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += '</div>';
            }
            
            answerGrid.innerHTML = html;
        }

        function show2ColumnTest() {
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('testFormat2Column').style.display = 'block';
            document.getElementById('answerSheetFormat').style.display = 'none';
        }

        function showAnswerSheet() {
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('testFormat2Column').style.display = 'none';
            document.getElementById('answerSheetFormat').style.display = 'block';
        }

        function showSimpleTest() {
            document.getElementById('testResult').style.display = 'block';
            document.getElementById('testFormat2Column').style.display = 'none';
            document.getElementById('answerSheetFormat').style.display = 'none';
        }

        function printTest() {
            const testFormat2Column = document.getElementById('testFormat2Column');
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            
            if (testFormat2Column.style.display !== 'none') {
                // å›ç­”ç”¨ç´™ã‚’éè¡¨ç¤ºã«ã—ã¦å•é¡Œç”¨ç´™ã®ã¿ã‚’å°åˆ·
                const originalAnswerDisplay = answerSheetFormat.style.display;
                answerSheetFormat.style.display = 'none';
                
                setTimeout(() => {
                    window.print();
                    // å°åˆ·å¾Œã¯å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                    answerSheetFormat.style.display = originalAnswerDisplay;
                }, 100);
            } else {
                alert('2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰å°åˆ·ã—ã¦ãã ã•ã„');
            }
        }

        function printAnswerSheet() {
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            const testFormat2Column = document.getElementById('testFormat2Column');
            
            if (answerSheetFormat.style.display !== 'none') {
                // å•é¡Œç”¨ç´™ã‚’éè¡¨ç¤ºã«ã—ã¦å›ç­”ç”¨ç´™ã®ã¿ã‚’å°åˆ·
                const originalTestDisplay = testFormat2Column.style.display;
                testFormat2Column.style.display = 'none';
                
                setTimeout(() => {
                    window.print();
                    // å°åˆ·å¾Œã¯å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                    testFormat2Column.style.display = originalTestDisplay;
                }, 100);
            } else {
                alert('å›ç­”ç”¨ç´™ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰å°åˆ·ã—ã¦ãã ã•ã„');
            }
        }

        function printBothSheets() {
            const testFormat2Column = document.getElementById('testFormat2Column');
            const answerSheetFormat = document.getElementById('answerSheetFormat');
            
            // ä¸¡æ–¹ã®ç”¨ç´™ã‚’è¡¨ç¤ºã—ã¦å°åˆ·
            const originalTestDisplay = testFormat2Column.style.display;
            const originalAnswerDisplay = answerSheetFormat.style.display;
            
            testFormat2Column.style.display = 'block';
            answerSheetFormat.style.display = 'block';
            
            setTimeout(() => {
                window.print();
                // å°åˆ·å¾Œã¯å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                testFormat2Column.style.display = originalTestDisplay;
                answerSheetFormat.style.display = originalAnswerDisplay;
            }, 100);
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function selectRange() {
            const startRow = parseInt(document.getElementById('startRow').value);
            const endRow = parseInt(document.getElementById('endRow').value);
            
            if (!startRow || !endRow) {
                alert('é–‹å§‹è¡Œã¨çµ‚äº†è¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (startRow > endRow) {
                alert('é–‹å§‹è¡Œã¯çµ‚äº†è¡Œã‚ˆã‚Šå°ã•ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            let selectedCount = 0;
            
            // æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
            deselectAll();
            
            for (let i = 0; i < checkboxes.length; i++) {
                const rowNumber = parseInt(checkboxes[i].value);
                if (rowNumber >= startRow && rowNumber <= endRow) {
                    checkboxes[i].checked = true;
                    selectedCount++;
                }
            }
            
            updateSelection();
            
            if (selectedCount > 0) {
                alert(`${startRow}è¡Œç›®ã‹ã‚‰${endRow}è¡Œç›®ã¾ã§ã®å˜èªã‚’é¸æŠã—ã¾ã—ãŸã€‚é¸æŠã•ã‚ŒãŸå˜èªæ•°: ${selectedCount}å€‹`);
            } else {
                alert('æŒ‡å®šã•ã‚ŒãŸç¯„å›²ã«å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }

        function clearRangeInputs() {
            document.getElementById('startRow').value = '';
            document.getElementById('endRow').value = '';
        }

        function selectRandomFromRange() {
            const startRow = parseInt(document.getElementById('randomStartRow').value);
            const endRow = parseInt(document.getElementById('randomEndRow').value);
            const count = parseInt(document.getElementById('randomCount').value);
            
            if (!startRow || !endRow || !count) {
                alert('é–‹å§‹è¡Œã€çµ‚äº†è¡Œã€å€‹æ•°ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (startRow > endRow) {
                alert('é–‹å§‹è¡Œã¯çµ‚äº†è¡Œã‚ˆã‚Šå°ã•ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const availableRows = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            
            // æŒ‡å®šç¯„å›²å†…ã®è¡Œç•ªå·ã‚’å–å¾—
            for (let i = 0; i < checkboxes.length; i++) {
                const rowNumber = parseInt(checkboxes[i].value);
                if (rowNumber >= startRow && rowNumber <= endRow) {
                    availableRows.push(checkboxes[i]);
                }
            }
            
            if (availableRows.length === 0) {
                alert('æŒ‡å®šã•ã‚ŒãŸç¯„å›²ã«å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            if (count > availableRows.length) {
                alert(`æŒ‡å®šã•ã‚ŒãŸç¯„å›²ã«ã¯${availableRows.length}å€‹ã®å˜èªã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚${count}å€‹ä»¥ä¸‹ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            // æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
            deselectAll();
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
            const shuffled = availableRows.sort(() => 0.5 - Math.random());
            for (let i = 0; i < count; i++) {
                shuffled[i].checked = true;
            }
            
            updateSelection();
            alert(`${startRow}è¡Œç›®ã‹ã‚‰${endRow}è¡Œç›®ã¾ã§ã®ç¯„å›²ã‹ã‚‰ã€ãƒ©ãƒ³ãƒ€ãƒ ã«${count}å€‹ã®å˜èªã‚’é¸æŠã—ã¾ã—ãŸã€‚`);
        }

        function clearRandomInputs() {
            document.getElementById('randomStartRow').value = '';
            document.getElementById('randomEndRow').value = '';
            document.getElementById('randomCount').value = '';
        }


        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateSelection();
        });
    </script>
</body>
</html>
