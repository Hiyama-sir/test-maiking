# EC2接続トラブルシューティング

EC2インスタンスに接続できない場合の確認事項と対処法

## 1. インスタンスの状態を確認

### AWSコンソールでの確認

1. EC2コンソールでインスタンスを選択
2. インスタンスの状態が「**running**（実行中）」になっているか確認
3. ステータスチェックが「**2/2 チェックに合格**」になっているか確認

**状態が「stopped」の場合**：
- 「インスタンスを起動」をクリック
- 起動するまで数分待つ

**ステータスチェックが失敗している場合**：
- インスタンスを再起動してみる
- しばらく待ってから再度確認

## 2. セキュリティグループの設定を確認

### SSH接続用のポート22が開いているか確認

1. EC2コンソールでインスタンスを選択
2. 「セキュリティ」タブをクリック
3. セキュリティグループ名をクリック
4. 「インバウンドルール」タブを確認

**必要なルール**：
- **タイプ**: SSH
- **プロトコル**: TCP
- **ポート範囲**: 22
- **ソース**: 
  - 自分のIPアドレス（推奨）
  - または `0.0.0.0/0`（任意の場所から接続可能）

**ルールがない場合**：
1. 「インバウンドルールを編集」をクリック
2. 「ルールを追加」をクリック
3. 以下を設定：
   - **タイプ**: SSH
   - **ポート範囲**: 22
   - **ソース**: 自分のIPアドレス（または `0.0.0.0/0`）
4. 「ルールを保存」をクリック

## 3. 接続方法を変更してみる

### EC2 Instance Connectが使えない場合

#### 方法1: Session Managerを使用

1. EC2コンソールでインスタンスを選択
2. 「接続」をクリック
3. 「セッションマネージャー」タブを選択
4. 「接続」をクリック

**初回使用の場合**：
- SSM Agentがインスタンスにインストールされている必要があります
- IAMロールに `AmazonSSMManagedInstanceCore` ポリシーが必要です

#### 方法2: SSHクライアントを使用（キーペアが必要）

1. EC2コンソールでインスタンスを選択
2. 「接続」をクリック
3. 「SSHクライアント」タブを選択
4. 表示されたコマンドをローカルマシンで実行

**キーペアの権限設定（macOS/Linux）**：
```bash
chmod 400 /path/to/your-key.pem
```

## 4. ネットワークの問題

### パブリックIPアドレスが付与されているか確認

1. EC2コンソールでインスタンスを選択
2. 「詳細」タブで以下を確認：
   - **パブリック IPv4 アドレス**: IPアドレスが表示されているか
   - **パブリック IPv4 DNS**: DNS名が表示されているか

**パブリックIPがない場合**：
- VPCの設定を確認
- サブネットがパブリックサブネットか確認
- パブリックIPの自動割り当てが有効か確認

### パブリックサブネットか確認

1. VPCコンソールに移動
2. インスタンスが使用しているサブネットを確認
3. インターネットゲートウェイにルーティングされているか確認

## 5. インスタンスを再起動

上記の確認をしても接続できない場合：

1. EC2コンソールでインスタンスを選択
2. 「インスタンスの状態」>「インスタンスを再起動」をクリック
3. 再起動が完了するまで数分待つ（2-3分程度）
4. 再度接続を試す

## 6. 新しいインスタンスを作成

どうしても接続できない場合、新しいインスタンスを作成することを検討：

1. 現在のインスタンスからスナップショットを取得（必要なデータがある場合）
2. 新しいインスタンスを起動
3. セキュリティグループでSSH（ポート22）を必ず開く
4. キーペアを正しく設定

## 7. よくあるエラーメッセージと対処法

### "Error establishing SSH connection"
- セキュリティグループでポート22が開いていない
- インスタンスが起動していない
- ネットワークの問題

### "Connection timed out"
- セキュリティグループの設定を確認
- ファイアウォールの設定を確認
- インスタンスのパブリックIPが正しいか確認

### "Permission denied"
- キーペアの権限を確認（`chmod 400`）
- 正しいキーペアを使用しているか確認

## 接続確認のチェックリスト

- [ ] インスタンスの状態が「running」
- [ ] ステータスチェックが「2/2 チェックに合格」
- [ ] セキュリティグループでSSH（ポート22）が開いている
- [ ] パブリックIPアドレスが付与されている
- [ ] インスタンスがパブリックサブネットにある
- [ ] インターネットゲートウェイが設定されている